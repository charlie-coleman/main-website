/**
 *
 *  -----------------------------------
 *  spotifyCurrentlyPlaying.js - v0.3.1
 *  -----------------------------------
 *
 *  Display your currently playing Spotify song(s) using Last.fm scrobbling.
 *
 *  https://github.com/kjbrum/spotifyCurrentlyPlaying.js
 *  @license Copyright (c) Kyle Brumm <http://kylebrumm.com>
 *
 */
!function(t){var e=function(t){return new e.init(t)};e.prototype={displayPlayer:function(){var t=this;if(!this.selector)throw"Missing selector";t.queryLastfm(function(){t.searchSpotify(function(){var e=t.selector;if("string"==typeof t.selector&&(e=document.querySelector(t.selector)),t.spotify_URIs.length>0||t.backup_ids.length>0){var s="",r=document.createElement("iframe");r.width=t.width,r.height=t.height,r.frameBorder=0,r.setAttribute("allowtransparency","true"),t.spotify_URIs.length>0?t.spotify_URIs.length>1?(s+="spotify:trackset:Recently+Played:",t.spotify_URIs.forEach(function(t,e,r){var i=r[e].split(":");s+=i[2],e+1!==r.length&&(s+=",")})):s=t.spotify_URIs[0]:t.backup_ids.length>1?(s+="spotify:trackset:Recently+Played:",t.backup_ids.forEach(function(t,e,r){s+=r[e],e+1!==r.length&&(s+=",")})):s=t.backup_ids[0],r.src="https://embed.spotify.com/?uri="+s+"&theme="+t.theme+"&view="+t.view,e.appendChild(r)}else{var i=document.createElement("p"),n=document.createTextNode("No track found.");i.appendChild(n),e.appendChild(i)}})})},queryLastfm:function(t){var e=this,s="http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user="+this.username+"&api_key="+this.api_key+"&limit="+e.count+"&format=json",r=new XMLHttpRequest;r.open("GET",s,!0),r.onload=function(){var s=JSON.parse(r.responseText),i=s.recenttracks.track;if(!(r.status>=200&&r.status<400))throw s.message;i.length>0&&(i[0]?i.forEach(function(t,s,r){e.lastfm_tracks[s]={title:r[s].name,artist:r[s].artist["#text"],album:r[s].album["#text"]}}):e.lastfm_tracks.push({title:i.name,artist:i.artist["#text"],album:i.album["#text"]})),t()},r.onerror=function(){throw"connection error"},r.send()},searchSpotify:function(t){var e=this,s=e.lastfm_tracks,r=1;s.length>0?s.forEach(function(s,i,n){var o="";for(var a in s)s.hasOwnProperty(a)&&s[a]&&(o+=a+":"+s[a]+" ");var c="https://api.spotify.com/v1/search?query="+encodeURIComponent(o)+"&offset=0&limit=1&type=track",p=new XMLHttpRequest;p.open("GET",c,!0),p.onload=function(){var s=JSON.parse(p.responseText);if(!(p.status>=200&&p.status<400))throw s.message;s.tracks.items[0]&&(e.spotify_URIs[i]=s.tracks.items[0].uri),++r===n.length&&(e.spotify_URIs=e.spotify_URIs.filter(function(t){return t}),t())},p.onerror=function(){throw"connection error"},p.send()}):t()}},e.init=function(t){var e=this;e.selector=t.selector||".scp-container",e.username=t.username||"",e.api_key=t.api_key||"",e.width=t.width||300,e.height=t.height||400,e.theme=t.theme||"black",e.view=t.view||"list",e.count=parseInt(t.count)||1,e.backup_ids=t.backup_ids||[],e.spotify_URIs=[],e.lastfm_tracks=[],e.displayPlayer()},e.init.prototype=e.prototype,t.SpotifyCurrentlyPlaying=t.SCP=e}(window);